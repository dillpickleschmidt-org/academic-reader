# This file is for local development (not used in prod)
services:
  # GPU worker for local Marker processing
  # Profile: local
  marker:
    build: ./workers/marker
    profiles: ["local"]
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    env_file:
      - .env.local
    volumes:
      - ./workers/marker/app:/app/app
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # GPU worker for local Chatterbox TTS (male_2, female_1)
  # Profile: local
  chatterbox-tts:
    build: ./workers/chatterbox-tts
    profiles: ["local"]
    command: uvicorn app.main:app --host 0.0.0.0 --port 8001
    volumes:
      - ./workers/chatterbox-tts/app:/app/app
      - ./workers/chatterbox-tts/voices:/app/voices
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # GPU worker for local Qwen3 TTS (male_1)
  # Profile: local
  qwen3-tts:
    build: ./workers/qwen3-tts
    profiles: ["local"]
    command: uvicorn app.main:app --host 0.0.0.0 --port 8002
    volumes:
      - ./workers/qwen3-tts/app:/app/app
      - ./workers/qwen3-tts/voices:/app/voices
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # Self-hosted API (Hono on Bun)
  # Profiles: local, datalab, runpod
  api:
    build:
      context: .
      dockerfile: Dockerfile
    profiles: ["local", "datalab", "runpod"]
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - "8787:8787"
    env_file:
      - .env.local
    environment:
      - NODE_ENV=development
      - PORT=8787
      - BACKEND_MODE=${BACKEND_MODE}
      - CONVEX_HTTP_URL=http://convex-backend:3211
      - CONVEX_SITE_URL=http://convex-backend:3210
      - CHATTERBOX_TTS_WORKER_URL=http://chatterbox-tts:8001
      - QWEN3_TTS_WORKER_URL=http://qwen3-tts:8002
      - S3_ENDPOINT=http://minio:9000
      - S3_PUBLIC_URL=http://localhost:9000/academic-reader
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET=academic-reader
    volumes:
      - ./web/server:/app/web/server
      - ./shared/core/src:/app/shared/core/src
      - tunnel_url:/tunnel:ro
    depends_on:
      convex-backend:
        condition: service_healthy
      marker:
        condition: service_started
        required: false
      chatterbox-tts:
        condition: service_started
        required: false
      qwen3-tts:
        condition: service_started
        required: false
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully

  # MinIO S3-compatible storage for all dev profiles
  minio:
    image: minio/minio
    profiles: ["local", "datalab", "runpod"]
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - ./minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Cloudflare tunnel for exposing MinIO to Runpod workers
  cloudflared:
    image: alpine:latest
    profiles: ["runpod"]
    depends_on:
      minio:
        condition: service_healthy
    command:
      - sh
      - -c
      - |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared
        chmod +x /usr/local/bin/cloudflared
        cloudflared tunnel --url http://minio:9000 2>&1 | while IFS= read -r line; do
          echo "$$line"
          case "$$line" in *trycloudflare.com*)
            echo "$$line" | grep -oE 'https://[^ ]+' > /tunnel/url ;;
          esac
        done
    volumes:
      - tunnel_url:/tunnel

  # MinIO bucket initialization
  minio-init:
    image: minio/mc
    profiles: ["local", "datalab", "runpod"]
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/academic-reader --ignore-existing;
      mc anonymous set download myminio/academic-reader;
      mc ilm rule add myminio/academic-reader --prefix 'temp_documents/' --expire-days 7 2>/dev/null || true;
      exit 0;
      "

  # Self-hosted Convex backend
  # Profiles: all dev modes (local, runpod, datalab)
  convex-backend:
    image: ghcr.io/get-convex/convex-backend:523c6812d3020300314f386b89a9c29560f21027
    profiles: ["local", "runpod", "datalab"]
    ports:
      - "3210:3210"
      - "3211:3211"
    environment:
      - CONVEX_CLOUD_ORIGIN=http://localhost:3210
      - CONVEX_SITE_ORIGIN=http://localhost:3211
      - DISABLE_BEACON=true
    volumes:
      - convex_data:/convex/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3210/version"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Self-hosted Convex dashboard (opt-in with --dashboard flag)
  convex-dashboard:
    image: ghcr.io/get-convex/convex-dashboard:523c6812d3020300314f386b89a9c29560f21027
    profiles: ["dashboard"]
    ports:
      - "6791:6791"
    environment:
      - NEXT_PUBLIC_DEPLOYMENT_URL=http://localhost:3210
    depends_on:
      convex-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6791"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  tunnel_url:
  convex_data:
